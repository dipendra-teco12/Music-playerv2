<!-- layout.ejs -->

<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="/adminlte/css/adminlte.min.css" />
    <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css" />
    <link
      rel="stylesheet"
      href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css"
    />
    <!-- DataTables CSS - Bootstrap 4 theme for AdminLTE compatibility -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-bs4.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />

    <title>Admin Panel</title>
    <style>
      /* Custom CSS to align DataTables controls on the same line */
      .dataTables_wrapper .dataTables_length {
        float: left;
        margin-bottom: 10px;
      }

      .dataTables_wrapper .dataTables_filter {
        float: right;
        margin-bottom: 10px;
      }

      .dataTables_wrapper .dataTables_info {
        float: left;
        margin-top: 10px;
        padding-top: 8px;
      }

      .dataTables_wrapper .dataTables_paginate {
        float: right;
        margin-top: 10px;
      }

      /* Clear floats after top controls */
      .dataTables_wrapper .dataTables_length::after,
      .dataTables_wrapper .dataTables_filter::after {
        content: "";
        display: table;
        clear: both;
      }

      /* Ensure the table clears the floated elements */
      .dataTables_wrapper .dataTable {
        clear: both;
        margin-top: 6px !important;
      }

      /* Style the filter input */
      .dataTables_filter input {
        margin-left: 5px;
        padding: 4px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
      }

      /* Style the length select */
      .dataTables_length select {
        padding: 4px 18px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        margin: 0 5px;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
          float: none;
          text-align: left;
          margin-bottom: 10px;
        }

        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
          float: none;
          text-align: center;
          margin-top: 10px;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  </head>
  <body class="hold-transition sidebar-mini">
    <div class="wrapper">
      <%-include('partials/alertBox') %> <%- include('partials/navbar') %> <%-
      include('partials/sidebar') %>
      <div class="content-wrapper">
        <section class="content">
          <div class="container-fluid"><%- body %></div>
        </section>
      </div>

      <%- include('partials/footer') %>
    </div>
    <!-- JavaScript files in correct order -->

    <script src="/adminlte/js/adminlte.min.js"></script>
    <!-- DataTables JavaScript -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>

    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
      integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
      crossorigin="anonymous"
    ></script>

    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.20/dist/summernote-bs4.min.js"></script>
    <!-- ✅ jQuery (required first) -->

    <!-- ✅ Popper.js for Bootstrap 4 -->
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>

    <!-- ✅ Bootstrap 4.6.2 JS (use only this) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>

    <script>
      let modalCallback = null;
      let modalCancelCallback = null;

      function showModal({
        title = "Confirm",
        message = "",
        confirmText = "OK",
        showCancel = true,
        onConfirm = null,
        onCancel = null,
      }) {
        // console.log("showModal called with:", {
        //   title,
        //   message,
        //   confirmText,
        //   showCancel,
        // });

        try {
          // Set modal content
          $("#globalModalLabel").text(title);
          $("#globalModalBody").html(message);
          $("#globalModalConfirmBtn").text(confirmText);

          // Store callbacks
          modalCallback = onConfirm;
          modalCancelCallback = onCancel;

          // Show/hide cancel button based on showCancel parameter
          if (showCancel === false) {
            $(".modal-footer .btn-danger").hide();
          } else {
            $(".modal-footer .btn-danger").show();
          }

          // Show the modal
          $("#globalModal").modal("show");

          // console.log("Modal should now be visible");

          // Check if modal is actually visible after a short delay
          setTimeout(() => {
            if ($("#globalModal").hasClass("show")) {
              console.log("Modal is now visible");
            } else {
              console.log("Modal is NOT visible - there might be an issue");
            }
          }, 500);
        } catch (error) {
          console.error("Error in showModal:", error);
          // Fallback to alert if modal fails
          if (confirm(message)) {
            if (typeof modalCallback === "function") {
              modalCallback();
            }
          } else {
            if (typeof modalCancelCallback === "function") {
              modalCancelCallback();
            }
          }
        }
      }

      // Handle confirm button click
      $("#globalModalConfirmBtn").on("click", function () {
        // console.log("Confirm button clicked");
        $("#globalModal").modal("hide");

        // Execute confirm callback after a small delay to ensure modal is hidden
        setTimeout(() => {
          if (typeof modalCallback === "function") {
            // console.log("Executing confirm callback");
            modalCallback();
          }
          // Reset callbacks
          modalCallback = null;
          modalCancelCallback = null;
        }, 100);
      });

      // Handle cancel button click
      $(document).on("click", ".modal-footer .btn-danger", function () {
        // console.log("Cancel button clicked");
        $("#globalModal").modal("hide");

        setTimeout(() => {
          if (typeof modalCancelCallback === "function") {
            console.log("Executing cancel callback");
            modalCancelCallback();
          }
          // Reset callbacks
          modalCallback = null;
          modalCancelCallback = null;
        }, 100);
      });

      // Handle when modal is closed without clicking any button (ESC key, clicking outside, etc.)
      $("#globalModal").on("hidden.bs.modal", function () {
        // console.log("Modal hidden");
        // Reset callbacks when modal is hidden
        modalCallback = null;
        modalCancelCallback = null;
      });

      // Debug: Log when DOM is ready
      // $(document).ready(function () {
        // console.log(
        //   "Document ready, showModal function available:",
        //   typeof showModal
        // );
        // console.log("jQuery version:", $.fn.jquery);
        // console.log("Bootstrap modal available:", typeof $.fn.modal);
        // Test if modal element exists
        // if ($("#globalModal").length > 0) {
        //   console.log("Modal element found in DOM");
        // } else {
        //   console.error("Modal element #globalModal NOT found in DOM!");
        // }
      // });

      // Additional debugging - log when window loads
      // $(window).on("load", function () {
      //   console.log(
      //     "Window loaded, showModal still available:",
      //     typeof showModal
      //   );
      // });
    </script>
  </body>
</html>
